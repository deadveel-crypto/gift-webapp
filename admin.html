<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Divine Admin</title>
  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body class="bg-slate-950 text-white">
  <div class="max-w-6xl mx-auto p-4">
    <div class="flex items-center justify-between gap-3 mb-4">
      <h1 class="text-2xl font-extrabold">Admin Panel</h1>
      <button id="reloadBtn" class="px-3 py-2 rounded-xl bg-indigo-600 hover:bg-indigo-500">Reload</button>
    </div>

    <div class="bg-white/5 border border-white/10 rounded-2xl p-4 mb-4">
      <div class="flex flex-col md:flex-row gap-3">
        <input id="q" class="flex-1 px-4 py-3 rounded-xl bg-black/30 border border-white/10 outline-none"
               placeholder="Search by ID / name / username" />
        <button id="searchBtn" class="px-4 py-3 rounded-xl bg-emerald-600 hover:bg-emerald-500">
          Search
        </button>
      </div>
      <div class="text-white/60 text-sm mt-3" id="meta">—</div>
    </div>

    <div class="overflow-auto bg-white/5 border border-white/10 rounded-2xl">
      <table class="min-w-full text-sm">
        <thead class="text-white/70">
          <tr class="border-b border-white/10">
            <th class="text-left p-3">ID</th>
            <th class="text-left p-3">Name</th>
            <th class="text-left p-3">Username</th>
            <th class="text-left p-3">Lang</th>
            <th class="text-left p-3">Sapphires</th>
            <th class="text-left p-3">Purchases</th>
            <th class="text-left p-3">Spent (Stars)</th>
            <th class="text-left p-3">Referrals</th>
            <th class="text-left p-3">Withdrawals</th>
            <th class="text-left p-3">Registered</th>
            <th class="text-left p-3">Ban</th>
          </tr>
        </thead>
        <tbody id="rows"></tbody>
      </table>
    </div>

    <div class="mt-4 flex justify-center">
      <button id="moreBtn" class="px-4 py-3 rounded-xl bg-white/10 hover:bg-white/15 border border-white/10">
        Load more
      </button>
    </div>
  </div>

<script>
const tg = window.Telegram?.WebApp;
if (tg) { try { tg.ready(); tg.expand(); } catch(e) {} }

const API = "/api/admin/users";
let offset = 0;
const limit = 50;
let lastQuery = "";

function esc(s){ return (s ?? "").toString(); }

async function fetchUsers(reset=false){
  const initData = tg?.initData || "";
  const query = document.getElementById("q").value.trim();
  if (reset){
    offset = 0;
    document.getElementById("rows").innerHTML = "";
    lastQuery = query;
  }

  const res = await fetch(API, {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({ init_data: initData, query: lastQuery, offset, limit })
  });

  const data = await res.json();
  if (!res.ok){
    document.getElementById("meta").textContent = "Error: " + (data.error || res.status);
    return;
  }

  document.getElementById("meta").textContent =
    `Total: ${data.total} | Showing: ${Math.min(offset + data.users.length, data.total)}/${data.total}`;

  const tbody = document.getElementById("rows");
  for (const u of data.users){
    const tr = document.createElement("tr");
    tr.className = "border-b border-white/5 hover:bg-white/5";

    tr.innerHTML = `
      <td class="p-3 font-mono">${u.user_id}</td>
      <td class="p-3">${esc(u.full_name)}</td>
      <td class="p-3">${u.username ? ("@" + esc(u.username)) : "—"}</td>
      <td class="p-3">${esc(u.lang)}</td>
      <td class="p-3">${u.sapphires}</td>
      <td class="p-3">${u.purchases_count}</td>
      <td class="p-3">${u.total_spent}</td>
      <td class="p-3">${u.referrals_count}</td>
      <td class="p-3">${u.withdrawals_count}</td>
      <td class="p-3">${esc(u.created_at).slice(0,19).replace("T"," ")}</td>
      <td class="p-3">${u.is_banned ? "BANNED" : "OK"}</td>
    `;
    tbody.appendChild(tr);
  }

  offset += data.users.length;
}

document.getElementById("searchBtn").onclick = () => fetchUsers(true);
document.getElementById("reloadBtn").onclick = () => fetchUsers(true);
document.getElementById("moreBtn").onclick = () => fetchUsers(false);

fetchUsers(true);
</script>
</body>
</html>
