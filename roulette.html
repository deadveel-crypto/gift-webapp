<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Roulette</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
  <style>
    body {
      background: #0f0f14;
      color: white;
      font-family: Arial, sans-serif;
      text-align: center;
      padding: 30px;
      min-height: 100vh;
    }

    .hidden { display: none; }

    button {
      padding: 12px 25px;
      font-size: 18px;
      border-radius: 10px;
      border: none;
      background: #4a7cff;
      color: white;
      cursor: pointer;
      margin-top: 15px;
    }

    button:disabled {
      background: gray;
      cursor: not-allowed;
    }

    #error {
      color: #ff5c5c;
      margin-top: 20px;
      white-space: pre-wrap;
    }

    #statusMessage {
      margin-top: 16px;
      color: #a7f3d0;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>

<h2>üé∞ –†—É–ª–µ—Ç–∫–∞</h2>

<div id="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>

<div id="app" class="hidden">
  <p>üíé –°–∞–ø—Ñ–∏—Ä—ã: <span id="sapphires">0</span></p>
  <p>‚≠ê –ó–≤—ë–∑–¥—ã: <span id="stars">0</span></p>
  <p>–°—Ç–æ–∏–º–æ—Å—Ç—å —Å–ø–∏–Ω–∞: <b><span id="cost">100</span></b></p>

  <button id="spinBtn">–ö—Ä—É—Ç–∏—Ç—å —Ä—É–ª–µ—Ç–∫—É</button>
  <div id="statusMessage"></div>
</div>

<div id="error"></div>

<script>
  const API_BASE = "https://deadveel.pythonanywhere.com";
  const tg = window.Telegram.WebApp;
  tg.ready();

  const initData = tg.initData;

  if (!initData) {
    showError("‚ùå Telegram initData –Ω–µ –ø–æ–ª—É—á–µ–Ω.\n–û—Ç–∫—Ä–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—É —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ –±–æ—Ç–∞.");
    throw new Error("No initData");
  }

  function showError(text) {
    document.getElementById("loading").classList.add("hidden");
    document.getElementById("app").classList.add("hidden");
    document.getElementById("error").innerText = text;
  }

  function showStatus(text) {
    const el = document.getElementById("statusMessage");
    el.textContent = text;
  }

  async function apiRequest(path, options = {}) {
    const res = await fetch(API_BASE + path, {
      ...options,
      headers: {
        "Content-Type": "application/json",
        "X-Telegram-Init-Data": initData,
        ...(options.headers || {})
      }
    });

    const data = await res.json();

    if (!res.ok || data.success === false) {
      throw new Error(data.error || "API error");
    }

    return data;
  }

  async function loadBalance() {
    try {
      const data = await apiRequest("/api/balance");

      document.getElementById("sapphires").innerText = data.sapphires;
      document.getElementById("stars").innerText = data.stars;
      document.getElementById("cost").innerText = data.spin_cost;

      const btn = document.getElementById("spinBtn");
      btn.disabled = !data.can_spin;

      document.getElementById("loading").classList.add("hidden");
      document.getElementById("app").classList.remove("hidden");

    } catch (e) {
      showError("‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±–∞–ª–∞–Ω—Å–∞:\n" + e.message);
    }
  }

  document.getElementById("spinBtn").addEventListener("click", async () => {
    const btn = document.getElementById("spinBtn");
    btn.disabled = true;
    showStatus("");

    try {
      await apiRequest("/api/spin", { method: "POST" });

      const prizes = [0, 25, 50, 100, 500];
      const prize = prizes[Math.floor(Math.random() * prizes.length)];

      const claimData = await apiRequest("/api/claim", {
        method: "POST",
        body: JSON.stringify({ stars: prize })
      });

      showStatus(prize > 0 
        ? `üéâ –¢—ã –≤—ã–∏–≥—Ä–∞–ª ${prize} ‚≠ê!` 
        : "üò¢ –ù–∏—á–µ–≥–æ –Ω–µ –≤—ã–ø–∞–ª–æ");

      document.getElementById("sapphires").innerText = claimData.new_sapphires;
      document.getElementById("stars").innerText = claimData.new_stars;

      btn.disabled = !claimData.can_spin;

    } catch (e) {
      showError("‚ùå –û—à–∏–±–∫–∞ —Å–ø–∏–Ω–∞:\n" + e.message);
    }
  });

  loadBalance();
</script>

</body>
</html>
