<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Roulette</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body {
      background: #0f0f14;
      color: white;
      font-family: Arial, sans-serif;
      text-align: center;
      padding: 30px;
    }

    .hidden { display: none; }

    button {
      padding: 12px 25px;
      font-size: 18px;
      border-radius: 10px;
      border: none;
      background: #4a7cff;
      color: white;
      cursor: pointer;
      margin-top: 15px;
    }

    button:disabled {
      background: gray;
      cursor: not-allowed;
    }

    #error {
      color: #ff5c5c;
      margin-top: 20px;
      white-space: pre-wrap;
    }
  </style>
</head>
<body>

<h2>üé∞ –†—É–ª–µ—Ç–∫–∞</h2>

<div id="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>

<div id="app" class="hidden">
  <p>üíé –°–∞–ø—Ñ–∏—Ä—ã: <span id="sapphires">0</span></p>
  <p>‚≠ê –ó–≤—ë–∑–¥—ã: <span id="stars">0</span></p>
  <p>–°—Ç–æ–∏–º–æ—Å—Ç—å —Å–ø–∏–Ω–∞: <b><span id="cost">100</span></b></p>

  <button id="spinBtn">–ö—Ä—É—Ç–∏—Ç—å —Ä—É–ª–µ—Ç–∫—É</button>
</div>

<div id="error"></div>

<script>
const API_BASE = "https://deadveel.pythonanywhere.com";

const tg = window.Telegram.WebApp;
tg.ready();

// ‚ö†Ô∏è –í–ê–ñ–ù–û: –±–µ—Ä—ë–º initData –∏–∑ Telegram
const initData = tg.initData;

if (!initData) {
  showError("‚ùå Telegram initData –Ω–µ –ø–æ–ª—É—á–µ–Ω.\n–û—Ç–∫—Ä–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—É —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ –±–æ—Ç–∞.");
  throw new Error("No initData");
}

function showError(text) {
  document.getElementById("loading").classList.add("hidden");
  document.getElementById("app").classList.add("hidden");
  document.getElementById("error").innerText = text;
}

async function apiRequest(path, options = {}) {
  const res = await fetch(API_BASE + path, {
    ...options,
    headers: {
      "Content-Type": "application/json",
      "X-Telegram-Init-Data": initData,
      ...(options.headers || {})
    }
  });

  const data = await res.json();

  if (!res.ok || data.success === false) {
    throw new Error(data.error || "API error");
  }

  return data;
}

// ==========================
// –ó–ê–ì–†–£–ó–ö–ê –ë–ê–õ–ê–ù–°–ê
// ==========================
async function loadBalance() {
  try {
    const data = await apiRequest("/api/balance");

    document.getElementById("sapphires").innerText = data.sapphires;
    document.getElementById("stars").innerText = data.stars;
    document.getElementById("cost").innerText = data.spin_cost;

    const btn = document.getElementById("spinBtn");
    btn.disabled = !data.can_spin;

    document.getElementById("loading").classList.add("hidden");
    document.getElementById("app").classList.remove("hidden");

  } catch (e) {
    showError("‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±–∞–ª–∞–Ω—Å–∞:\n" + e.message);
  }
}

// ==========================
// –°–ü–ò–ù
// ==========================
document.getElementById("spinBtn").addEventListener("click", async () => {
  const btn = document.getElementById("spinBtn");
  btn.disabled = true;

  try {
    // —Å–ø–∏—Å—ã–≤–∞–µ–º —Å–∞–ø—Ñ–∏—Ä—ã
    const spinData = await apiRequest("/api/spin", {
      method: "POST"
    });

    // —Å–ª—É—á–∞–π–Ω—ã–π –ø—Ä–∏–∑ (–ª–æ–≥–∏–∫–∞ —Ñ—Ä–æ–Ω—Ç–∞)
    const prizes = [0, 25, 50, 100, 500];
    const prize = prizes[Math.floor(Math.random() * prizes.length)];

    // –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤—ã–∏–≥—Ä—ã—à –Ω–∞ —Å–µ—Ä–≤–µ—Ä
    const claimData = await apiRequest("/api/claim", {
      method: "POST",
      body: JSON.stringify({ stars: prize })
    });

    alert(prize > 0 
      ? `üéâ –¢—ã –≤—ã–∏–≥—Ä–∞–ª ${prize} ‚≠ê!` 
      : "üò¢ –ù–∏—á–µ–≥–æ –Ω–µ –≤—ã–ø–∞–ª–æ");

    // –æ–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å
    document.getElementById("sapphires").innerText = claimData.new_sapphires;
    document.getElementById("stars").innerText = claimData.new_stars;

    btn.disabled = !claimData.can_spin;

  } catch (e) {
    showError("‚ùå –û—à–∏–±–∫–∞ —Å–ø–∏–Ω–∞:\n" + e.message);
  }
});

// —Å—Ç–∞—Ä—Ç
loadBalance();
</script>

</body>
</html>
